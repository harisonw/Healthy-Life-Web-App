<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HL</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="css/style.css" />
    <!-- Apple button, may remove -->
    <meta name="appleid-signin-client-id" content="[CLIENT_ID]" />
    <meta name="appleid-signin-scope" content="[SCOPES]" />
    <meta name="appleid-signin-redirect-uri" content="[REDIRECT_URI]" />
    <meta name="appleid-signin-state" content="[STATE]" />
    <meta name="appleid-signin-nonce" content="[NONCE]" />
    <link rel="icon" type="image/x-icon" href="/img/favicon-32x32.png" />
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html"
          ><img src="img/Healthy_Life-Logo-White.png" alt="HL Logo" height="40"
        /></a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavDropdown"
          aria-controls="navbarNavDropdown"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="home.html">Home</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="profile.html"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Categories
              </a>
              <!-- Category Dropdown, Would be good to populate from database of all Categories-->
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="catagory.html">Category 1</a>
                </li>
                <li><a class="dropdown-item" href="#">Category 2</a></li>
                <li><a class="dropdown-item" href="#">Category 3</a></li>
                <li><a class="dropdown-item" href="#">Category 4</a></li>
                <li><a class="dropdown-item" href="#">Category 5</a></li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="hlhacks.html"
                >HL Hacks</a
              >
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="profile.html"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Profile
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="profile.html">Profile</a>
                </li>
                <li>
                  <a class="dropdown-item" href="connections.html"
                    >Connections</a
                  >
                </li>
              </ul>
            </li>
          </ul>
          <!--- Only show if not signed in, else if logged in show logout button --->
          <a id="loginButton" class="btn btn-primary ms-auto" href="login.html" role="button"
            >Login or Register</a
          >
          <a
            id="logoutButton"
            class="btn btn-primary ms-auto"
            href="login.html"
            hidden="hidden"
            role="button"
            >Logout</a
          >
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <!-- create a post section where users can upload images -->
      <div class="row">
        <div class="col-md-12 my-2">
          <div class="card">
            <div class="card-body">
              <form>
                <div class="mb-3">
                  <h1>Share a healthy life hack!</h1>
                  <label for="titleTextarea" class="form-label">Title:</label>
                  <textarea
                    class="form-control"
                    id="titleTextarea"
                    rows="1"
                  ></textarea>
                  <label for="postTextarea" class="form-label">Post:</label>
                  <textarea
                    class="form-control"
                    id="postTextarea"
                    rows="3"
                  ></textarea>
                </div>
                <div class="mb-3">
                  <label for="formFile" class="form-label"
                    >Upload a Photo</label
                  >
                  <input class="form-control" type="file" id="formFile" />
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <button id="submitPostButton"type="button" class="btn btn-primary">
                      Submit
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- end of create a post section -->
      <!-- display posts section -->
      <!-- make posts same size -->

      <div id="postRow" class="row">

      </div>
    </div>

    <script>

      // get user for like/unlike view
      var user = fetch("http://localhost:3000/api/user/get-user", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          placeholder: 'placeholder',
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          user = data;
        });


      function getPosts() {
        console.log("starting");
        // get posts from database
        var posts = fetch("http://localhost:3000/api/posts/get-all", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            // reverse loop through posts and display them
            for (var i = data.length - 1; i >= 0; i--) {
              var post = data[i];
              var postRow = document.getElementById("postRow");
              var postCol = document.createElement("div");
              postCol.className = "col-md-4 my-2";
              var card = document.createElement("div");
              card.className = "card";
              card.id = post._id; // use for like function
              var cardBody = document.createElement("div");
              cardBody.className = "card-body";
              var title = document.createElement("h5");
              title.className = "mt-1";
              title.innerHTML = post.title;
              var description = document.createElement("p");
              description.className = "mx-2";
              description.innerHTML = post.body;
              var image = document.createElement("img");
              image.className = "img-fluid card-img-top";
              image.src = post.image;
              var likeButton = document.createElement("button");
              likeButton.id = post._id // use for like function
              likeButton.className = "likeButton btn btn-primary mt-2";
              // if user has liked post, show unlike button
              console.log("id", user._id)
              console.log("likes: " + post.likes);
              if (post.likes.includes(user._id)) {
                likeButton.innerHTML = "Unlike <small>(" + post.likes.length + ")</small>";
              } else {
                likeButton.innerHTML = "Like <small>(" + post.likes.length + ")</small>";
              }
              
              var time = document.createElement("p");
              time.className = "text-secondary mb-0";
              // calculate time since post
              var timeSince = new Date() - new Date(post.createdAt);
              timeSince = Math.floor(timeSince / 1000 / 60);
              if (timeSince < 60) {
                time.innerHTML = timeSince + " Minutes Ago";
              } else {
                timeSince = Math.floor(timeSince / 60);
                time.innerHTML = timeSince + " Hours Ago";
              }
              
              // add user who posted
              var userPosted = document.createElement("p");
              userPosted.className = "text-secondary mb-0";
              userPosted.innerHTML = "Posted by: " + post.user.fname;

              cardBody.appendChild(title);
              cardBody.appendChild(description);
              cardBody.appendChild(image);
              cardBody.appendChild(likeButton);
              cardBody.appendChild(time);
              cardBody.appendChild(userPosted);
              card.appendChild(cardBody);
              postCol.appendChild(card);
              postRow.appendChild(postCol);
            }
          })
          .then(() => {
            // add event listeners to like buttons
            var likeButtons = document.getElementsByClassName("likeButton");
            for (var i = 0; i < likeButtons.length; i++) {
              console.log("like button: :", likeButtons[i]);
              likeButtons[i].addEventListener("click", function () {
                likePost(this.id);
                location.reload();
              });
            }
          });

      };

      getPosts();

      // when user likes a post, update the database
      function likePost(postID) {
        console.log("like post", postID);
        var post = fetch("http://localhost:3000/api/posts/like", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            postID: postID,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
          });
      };


      // wait for dom to load
      document.addEventListener("DOMContentLoaded", function () {
        console.log("dom loaded");
        // add event listener to submit post button
        document
          .getElementById("submitPostButton")
          .addEventListener("click", function () {
            console.log("submit post button clicked");
            // get values from form
            var title = document.getElementById("titleTextarea").value;
            var body = document.getElementById("postTextarea").value;
            var image = document.getElementById("formFile").value;
            // check values are not empty
            if (title == "" || body == "") {
              alert("Please fill in all fields");
              return;
            }
            // send post to database
            var post = fetch("http://localhost:3000/api/posts/create", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                title: title,
                body: body,
                image: image,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                console.log(data);
              });
          });
      });




    </script>

    <!-- Footer -->
    <footer class="bg-dark text-center text-white mt-3">
      <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2)">
        © 2022 Copyright: Healthy Life
      </div>
    </footer>

    <script src="js/loginButton.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
